
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/css/style_crud.css">
    <link rel="stylesheet" href="/css/user_btn.css">
    <link rel="stylesheet" href="/css/nav.css">
    <link rel="stylesheet" href="/css/footer.css">
</head>
<body>
    <%- include('partials/nav') %>

    <div class="container">
        <header class="admin-header">
            <h1>Admin Dashboard</h1>
            <p class="muted">Manage universities, faculties, departments, and events</p>
        </header>

        <div class="tabs" role="tablist">
            <div class="tab" data-tab="universities">Universities</div>
            <div class="tab" data-tab="faculties">Faculties</div>
            <div class="tab active" data-tab="departments">Departments</div>
            <div class="tab" data-tab="events">Events</div>
        </div>

        <section class="panel" id="panel-universities" style="display:none;">
            <div class="panel-header">
                <div>
                    <h3>Universities</h3>
                    <p class="muted">Manage university information</p>
                </div>
                <button class="btn-primary" onclick="onAdd('university')">+ Add University</button>
            </div>
            <table class="admin-table">
                <thead>
                    <tr><th>Name</th><th>Location</th><th>Website</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    <% const uniSample = (typeof universities !== 'undefined' && universities) ? universities : [{name:'มหาวิทยาลัย A', location:'กรุงเทพฯ', website:'www.unia.ac.th'}]; %>
                    <% uniSample.forEach(function(u){ %>
                        <tr>
                            <td><%= u.name || u.UniversityName || 'Unknown' %></td>
                            <td><%= u.location || u.Location || '-' %></td>
                            <td><%= u.website || u.Website || '-' %></td>
                              <td class="actions"><button class="icon-btn" data-id="<%= u.id || '' %>" onclick="onEdit('university', this.dataset.id)">✎</button><button class="icon-btn" data-id="<%= u.id || '' %>" onclick="onDelete('university', this.dataset.id)">🗑</button></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </section>

        <section class="panel" id="panel-faculties" style="display:none;">
            <div class="panel-header">
                <div>
                    <h3>Faculties</h3>
                    <p class="muted">Manage faculty information</p>
                </div>
                <button class="btn-primary" onclick="onAdd('faculty')">+ Add Faculty</button>
            </div>
            <table class="admin-table">
                <thead>
                    <tr><th>Name</th><th>University</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    <% const facSample = (typeof faculties !== 'undefined' && faculties) ? faculties : [{name:'Computer Science', university:'มหาวิทยาลัย A'}]; %>
                    <% facSample.forEach(function(f){ %>
                        <tr>
                            <td><%= f.name || f.FacultyName || 'Unknown' %></td>
                            <td><%= f.university || f.University || '-' %></td>
                              <td class="actions"><button class="icon-btn" data-id="<%= f.id || '' %>" onclick="onEdit('faculty', this.dataset.id)">✎</button><button class="icon-btn" data-id="<%= f.id || '' %>" onclick="onDelete('faculty', this.dataset.id)">🗑</button></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </section>

        <section class="panel" id="panel-departments">
            <div class="panel-header">
                <div>
                    <h3>Departments</h3>
                    <p class="muted">Manage department information</p>
                </div>
                <button class="btn-primary" onclick="onAdd('department')">+ Add Department</button>
            </div>

            <table class="admin-table">
                <thead>
                    <tr><th>Name</th><th>Faculty</th><th>University</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    <% const depSample = (typeof departments !== 'undefined' && departments) ? departments : [
                            {name:'Software Engineering', faculty:'Computer Science',university:'มหาวิทยาลัย A'},
                            {name:'Marketing', faculty:'Business Administration', university:'มหาวิทยาลัย A'}
                        ]; %>
                    <% depSample.forEach(function(d, idx){ %>
                        <tr>
                            <td><%= d.name || d.DepartmentName || 'Unknown' %></td>
                            <td><%= d.faculty || d.Faculty || '-' %></td>
                            <td><%= d.university || d.University || '-' %></td>
                            <td class="actions">
                            <button class="icon-btn" data-id="<%= d.id != null ? d.id : idx %>" onclick="onEdit('department', this.dataset.id)">✎</button>
                            <button class="icon-btn" data-id="<%= d.id != null ? d.id : idx %>" onclick="onDelete('department', this.dataset.id)">🗑</button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </section>

        <section class="panel" id="panel-events" style="display:none;">
            <div class="panel-header">
                <div>
                    <h3>Events</h3>
                    <p class="muted">Manage events</p>
                </div>
                <button class="btn-primary" onclick="onAdd('event')">+ Add Event</button>
            </div>
            <table class="admin-table">
                <thead>
                    <tr><th>Title</th><th>Date</th><th>Location</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    <% const evSample = (typeof events !== 'undefined' && events) ? events : [{title:'Open House 2025', date:'2025-09-01', location:'มหาวิทยาลัย A'}]; %>
                    <% evSample.forEach(function(e){ %>
                        <tr>
                            <td><%= e.title || e.Title || 'Untitled' %></td>
                            <td><%= e.date || '-' %></td>
                            <td><%= e.location || '-' %></td>
                              <td class="actions"><button class="icon-btn" data-id="<%= e.id || '' %>" onclick="onEdit('event', this.dataset.id)">✎</button><button class="icon-btn" data-id="<%= e.id || '' %>" onclick="onDelete('event', this.dataset.id)">🗑</button></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </section>

    </div>

        <!-- Modal UI (client-only) -->
        <div id="add-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:1200;"> 
            <div style="width:640px;max-width:95%;margin:48px auto;background:#fff;border-radius:8px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.15);">
                <h3 id="add-modal-title">Add</h3>
                <form id="add-modal-form">
                    <!-- University -->
                    <div id="form-university" style="display:none">
                        <label style="display:block;font-size:13px;margin-top:8px">ชื่อมหาวิทยาลัย</label>
                        <input id="uni-name" type="text" placeholder="ชื่อมหาวิทยาลัย" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px" />
                        <label style="display:block;font-size:13px;margin-top:8px">ที่ตั้ง</label>
                        <input id="uni-location" type="text" placeholder="เช่น กรุงเทพมหานคร" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px" />
                        <label style="display:block;font-size:13px;margin-top:8px">เว็บไซต์</label>
                        <input id="uni-website" type="url" placeholder="https://example.ac.th" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px" />
                    </div>

                    <!-- Faculty -->
                    <div id="form-faculty" style="display:none">
                        <label style="display:block;font-size:13px;margin-top:8px">มหาวิทยาลัย</label>
                        <select id="fac-university" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px"></select>
                        <label style="display:block;font-size:13px;margin-top:8px">ชื่อคณะ</label>
                        <input id="fac-name" type="text" placeholder="ชื่อคณะ" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px" />
                    </div>

                    <!-- Department -->
                    <div id="form-department" style="display:none">
                        <label style="display:block;font-size:13px;margin-top:8px">มหาวิทยาลัย</label>
                        <select id="dept-university" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px"></select>
                        <label style="display:block;font-size:13px;margin-top:8px">คณะ</label>
                        <select id="dept-faculty" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px"></select>
                        <label style="display:block;font-size:13px;margin-top:8px">ชื่อสาขา</label>
                        <input id="dept-name" type="text" placeholder="ชื่อสาขา" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px" />
                    </div>

                    <div style="text-align:right;margin-top:12px">
                        <button type="button" id="add-modal-cancel" class="btn-primary" style="background:#eee;color:#111;border:0;padding:8px 12px;border-radius:4px">ยกเลิก</button>
                        <button type="submit" class="btn-primary" style="margin-left:8px">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>

    <%- include('partials/footer') %>

    <!-- data container (JSON embedded safely in HTML attributes) -->
    <div id="__DATA__container" style="display:none;"
         data-universities='<%- JSON.stringify(typeof universities !== "undefined" ? universities : []) %>'
         data-faculties='<%- JSON.stringify(typeof faculties !== "undefined" ? faculties : []) %>'></div>

    <script>
        // parse embedded JSON from data container
        const __DATA_CONTAINER = document.getElementById('__DATA__container');
        const __UNIVERSITIES = JSON.parse(__DATA_CONTAINER?.getAttribute('data-universities') || '[]');
        const __FACULTIES = JSON.parse(__DATA_CONTAINER?.getAttribute('data-faculties') || '[]');

                // helper to populate a select with university options
                function populateUniversitySelect(sel){
                    sel.innerHTML = '<option value="">-- เลือกมหาวิทยาลัย --</option>';
                    (window.__UNIVERSITIES || []).forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u.id ?? u.UniversityID ?? u.ID ?? u.id ?? '';
                        opt.textContent = u.name ?? u.UniversityName ?? u.University ?? 'Unknown';
                        sel.appendChild(opt);
                    });
                }

                // populate faculty select filtered by university id
                function populateFacultySelectForUniversity(sel, universityId){
                    sel.innerHTML = '<option value="">-- เลือกคณะ --</option>';
                    const facs = window.__FACULTIES || [];
                    facs.forEach(f => {
                        const fUniId = f.universityId ?? f.UniversityID ?? f.UniversityId ?? f.university ?? f.University ?? '';
                        const fName = f.name ?? f.FacultyName ?? f.Faculty ?? 'Unknown';
                        const include = (!universityId) || String(fUniId) === String(universityId) || String(fUniId) === String((window.__UNIVERSITIES.find(u=>String(u.name||u.University||u.UniversityName)===String(universityId))||{}).id);
                        if(include){
                            const opt = document.createElement('option');
                            opt.value = f.id ?? f.FacultyID ?? f.ID ?? '';
                            opt.textContent = fName;
                            sel.appendChild(opt);
                        }
                    });
                }

                // Simple tab switching
                document.querySelectorAll('.tabs .tab').forEach(tab => {
                        tab.addEventListener('click', () => {
                                document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
                                tab.classList.add('active');
                                const name = tab.dataset.tab;
                                document.querySelectorAll('section.panel').forEach(p=>p.style.display='none');
                                const panel = document.getElementById('panel-' + name);
                                if(panel) panel.style.display = '';
                        });
                });

                // Modal helpers (client-only UI)
                const addModal = document.getElementById('add-modal');
                const addModalTitle = document.getElementById('add-modal-title');
                const addModalForm = document.getElementById('add-modal-form');
                const addModalCancel = document.getElementById('add-modal-cancel');
                const formUniversity = document.getElementById('form-university');
                const formFaculty = document.getElementById('form-faculty');
                const formDepartment = document.getElementById('form-department');
                const uniNameInput = document.getElementById('uni-name');
                const uniLocationInput = document.getElementById('uni-location');
                const uniWebsiteInput = document.getElementById('uni-website');
                const facUniversitySelect = document.getElementById('fac-university');
                const facNameInput = document.getElementById('fac-name');
                const deptUniversitySelect = document.getElementById('dept-university');
                const deptFacultySelect = document.getElementById('dept-faculty');
                const deptNameInput = document.getElementById('dept-name');

                // initialize selects from embedded data
                populateUniversitySelect(facUniversitySelect);
                populateUniversitySelect(deptUniversitySelect);
                populateFacultySelectForUniversity(deptFacultySelect, '');

                function onAdd(type){
                        // show modal with contextual title and reveal proper form
                        addModal.dataset.type = type;
                        addModalTitle.textContent = (type === 'university') ? 'เพิ่มมหาวิทยาลัย' : (type === 'faculty') ? 'เพิ่มคณะ' : (type === 'department') ? 'เพิ่มสาขา' : 'Add';
                        // hide all forms
                        formUniversity.style.display = 'none';
                        formFaculty.style.display = 'none';
                        formDepartment.style.display = 'none';
                        // show the right one
                        if(type === 'university'){
                            formUniversity.style.display = '';
                        } else if(type === 'faculty'){
                            formFaculty.style.display = '';
                        } else if(type === 'department'){
                            formDepartment.style.display = '';
                        }
                        // reset inputs
                        uniNameInput.value = '';
                        uniLocationInput.value = '';
                        uniWebsiteInput.value = '';
                        facNameInput.value = '';
                        deptNameInput.value = '';
                        addModal.style.display = 'block';
                        setTimeout(()=>{
                            const first = addModal.querySelector('input, select');
                            if(first) first.focus();
                        }, 60);
                }

                function closeAddModal(){ addModal.style.display = 'none'; addModal.dataset.type = ''; }

                addModalCancel.addEventListener('click', ()=> closeAddModal());

                // when dept university changes, repopulate faculty select
                deptUniversitySelect.addEventListener('change', (e)=>{
                        populateFacultySelectForUniversity(deptFacultySelect, e.target.value);
                });

                addModalForm.addEventListener('submit', (e)=>{
                        e.preventDefault();
                        const type = addModal.dataset.type || 'item';
                        if(type === 'university'){
                            const payload = { name: uniNameInput.value.trim(), location: uniLocationInput.value.trim(), website: uniWebsiteInput.value.trim() };
                            if(!payload.name) return alert('กรุณากรอกชื่อมหาวิทยาลัย');
                            console.log('Add University (UI only):', payload);
                            alert('เพิ่มมหาวิทยาลัย: ' + payload.name);
                        } else if(type === 'faculty'){
                            const payload = { universityId: facUniversitySelect.value, name: facNameInput.value.trim() };
                            if(!payload.universityId || !payload.name) return alert('กรุณาเลือกมหาวิทยาลัยและกรอกชื่อคณะ');
                            console.log('Add Faculty (UI only):', payload);
                            alert('เพิ่มคณะ: ' + payload.name);
                        } else if(type === 'department'){
                            const payload = { universityId: deptUniversitySelect.value, facultyId: deptFacultySelect.value, name: deptNameInput.value.trim() };
                            if(!payload.universityId || !payload.facultyId || !payload.name) return alert('กรุณากรอกข้อมูลให้ครบ');
                            console.log('Add Department (UI only):', payload);
                            alert('เพิ่มสาขา: ' + payload.name);
                        } else {
                            const name = (document.getElementById('add-modal-name') || {}).value || '';
                            console.log('Add generic (UI only):', { type, name });
                        }
                        closeAddModal();
                });

                // keep existing edit/delete placeholders
                function onEdit(type, id){
                        const parsedId = id ? id : null;
                        const name = prompt('Edit ' + type + ' name (id='+ parsedId +')');
                        if(name) alert('Save changes for ' + type + ' id='+ parsedId + ' (implement API call)');
                }
                function onDelete(type, id){
                        const parsedId = id ? id : null;
                        if(confirm('Delete ' + type + ' id=' + parsedId + '?')){
                                alert('Deleted (implement API call)');
                        }
                }
        </script>
</body>
</html>



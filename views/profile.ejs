<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/css/style_profile.css">
    <link rel="stylesheet" href="/css/user_btn.css">
    <link rel="stylesheet" href="/css/nav.css">
    <link rel="stylesheet" href="/css/footer.css">

</head>
    <body>
        <%- include('partials/nav'); %>

        <main class="profile-page-content">
            <div class="container">
                <!-- Blue header similar to design -->
                <section class="profile-header-large">
                    <div class="profile-header-inner container-grid">
                        <div class="avatar-column">
                            <div class="avatar-wrapper">
                                <img src="/images/user.png" alt="avatar" class="profile-picture-large">
                                <div class="avatar-role">Student</div>
                            </div>
                            <div class="profile-actions">
                                <button class="btn edit-btn"><i class="fas fa-cog"></i> แก้ไขข้อมูล</button>
                            </div>
                        </div>
                        <div class="info-column">
                            <div class="line name-line"><%= [(user && user.first_name) || '', (user && user.last_name) || ''].join(' ').trim() || 'ไม่พบชื่อผู้ใช้' %></div>
                            <div class="line school-line"><%= (user && user.school_name) || 'โรงเรียน' %></div>
                            <div class="line email-line"><%= (user && user.email) || '-' %></div>
                            <div class="line phone-line"><%= (user && user.phone) || '-' %></div>
                        </div>
                    </div>
                </section>

                <section class="registered-events-section">
                    <h2 class="section-title">กิจกรรมที่เข้าร่วมแล้ว</h2>
                    <div class="card-container">
                        <% if ((registeredEvents || []).length === 0) { %>
                            <p class="muted">ยังไม่มีการลงทะเบียนกิจกรรม</p>
                        <% } else { %>
                            <% registeredEvents.forEach(function(ev) { %>
                                <div class="card">
                                    <div class="card-header">
                                        <div class="tags">
                                            <span class="tag university"><%= ev.university || 'มหาวิทยาลัย' %></span>
                                        </div>
                                        <h3><%= ev.title %></h3>
                                    </div>
                                    <div class="card-body">
                                        <p><i class="fas fa-calendar-alt"></i> <%= ev.date || '-' %></p>
                                        <p><i class="fas fa-clock"></i> <%= ev.time || '-' %></p>
                                        <p><i class="fas fa-map-marker-alt"></i> <%= ev.location || '-' %></p>
                                        <p class="description"><%= ev.description ? (ev.description.length > 140 ? ev.description.slice(0,137) + '...' : ev.description) : '' %></p>
                                    </div>
                                    <div class="card-footer">
                                        <form method="post" action="/event/unregister" style="display:inline">
                                            <input type="hidden" name="eventId" value="<%= ev.id %>">
                                            <button type="submit" class="btn join-btn">ยกเลิกกิจกรรม</button>
                                        </form>
                                        <button type="button" class="btn btn-primary detail-btn" data-id="<%= ev.id %>" data-title="<%= (ev.title||'').replace(/\"/g,'&quot;') %>" data-location="<%= (ev.location||'') .replace(/\"/g,'&quot;') %>" data-time="<%= (ev.date||'') + ' ' + (ev.time||'') %>">ดูรายละเอียด</button>
                                    </div>
                                </div>
                            <% }); %>
                        <% } %>
                    </div>
                </section>
            </div>
        </main>

        <footer class="footer">
            <div class="container">
                <p>สร้างด้วย <i class="fas fa-heart"></i> โดย <a href="#">Lienable</a></p>
            </div>
        </footer>
        <script>
            const user = JSON.parse('<%- JSON.stringify(user || {}) %>');
            console.log("user =", user);
        </script>
        <!-- Edit profile modal -->
        <div id="editProfileModal" class="modal" style="display:none">
            <div class="modal-overlay"></div>
            <div class="modal-dialog">
                <h3>แก้ไขข้อมูลส่วนตัว</h3>
                <form id="editProfileForm">
                    <div class="form-row">
                        <label>ชื่อ</label>
                        <input type="text" name="first_name" id="first_name">
                    </div>
                    <div class="form-row">
                        <label>นามสกุล</label>
                        <input type="text" name="last_name" id="last_name">
                    </div>
                    <div class="form-row">
                        <label>อีเมล</label>
                        <input type="email" name="email" id="email">
                    </div>
                    <div class="form-row">
                        <label>โทรศัพท์</label>
                        <input type="text" name="phone" id="phone">
                    </div>
                    <div class="form-row">
                        <label>โรงเรียน</label>
                        <input type="text" name="school_name" id="school_name">
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancelEdit" class="btn">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Detail Modal -->
        <div id="detailModal" class="modal" style="display:none">
            <div class="modal-overlay"></div>
            <div class="modal-dialog">
                <div class="detail-header">
                    <h3>รายละเอียดกิจกรรม</h3>
                </div>
                <div class="detail-body">
                    <img id="detail-qr" src="/images/qrcode.png" alt="QR code">
                    <p class="success-line"><strong>กิจกรรม:</strong> <span id="success-event-name"></span></p>
                    <p class="success-line"><strong>สถานที่:</strong> <span id="success-location"></span></p>
                    <p class="success-line"><strong>เวลาเริ่ม - เวลาสิ้นสุด:</strong> <span id="success-time"></span></p>
                </div>
                <div class="form-actions">
                    <button type="button" id="closeDetail" class="btn">ปิด</button>
                </div>
            </div>
        </div>

        <script src="/js/profile.js"></script>
    </body>
</html>
